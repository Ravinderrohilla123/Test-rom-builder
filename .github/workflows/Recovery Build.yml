name: Android ROM Build

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    - name: Set up Java
      uses: actions/setup-java@v2
      with:
        distribution: 'adopt'
        java-version: '11'

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc \
          bison \
          build-essential \
          ccache \
          curl \
          flex \
          g++-multilib \
          gcc-multilib \
          git \
          gnupg \
          gperf \
          imagemagick \
          lib32ncurses5-dev \
          lib32readline-dev \
          lib32z1-dev \
          liblz4-tool \
          libncurses5-dev \
          libsdl1.2-dev \
          libssl-dev \
          libxml2 \
          libxml2-utils \
          lzop \
          pngcrush \
          schedtool \
          squashfs-tools \
          xsltproc \
          zip \
          zlib1g-dev

    - name: Download Repo Tool
      run: |
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        export PATH=~/bin:$PATH

    - name: Initialize Repo
      run: |
        repo init -u https://github.com/PixelExperience/manifest -b thirteen
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags
    - name: Sync Device Tree and Vendor Tree
      run: |
        git clone https://github.com/Ravinderrohilla123/Devtree_nonbooting.git device/realme/RMX2117
        git clone https://github.com/Ravinderrohilla123/Vendor_nonbooting.git vendor/realme/RMX2117

    - name: Source Environment Variables
      run: source build/envsetup.sh

    - name: Lunch Configuration
      run: lunch aosp_RMX2117-userdebug

    - name: Build ROM
      run: |
        mka bacon

    - name: Upload Artifacts
      uses: actions/upload-artifact@v2
      with:
        name: rom-artifacts
        path: out/target/product/rmx2117
